<?php
    header('Content-Type: application/json');
    require_once "../../dbhelper.php";

    $wingoal =500000;
    $dmgdiff = 0;

    $bossex =1;
    $bossamp=1;
    $stdex=1;
    $stdamp=1;
    $stdadd = 0;
    $time=0;
    $boss_tempmod = 1;
    $stud_tempmod = 1;
    $booster_countdown = 0;
    $stun = 0;
    $bossphase = 1;
    $tincrement = 1;


    $item_13_check = 0;
    $item_14_check = 0;

    function bossdmg($damage)
    {
        $dmgdiff -= $damage;
    }

    function studentdmg($damage)
    {
        $dmgdiff += $damage;
    }

    function gethpx()
    {
        $x = 480*($dmgdiff+$wingoal)/($wingoal*2);
        return $x;
    }
     
    
    
    function getdpss()
    {
        return ((100+$stdex)*(1+0.5*(1.2*log(M_E+($time/50))))*(1.2*log(M_E+($time/50)))*($stdamp)+($stdadd))*$stud_tempmod;
    }
    
    function getdpsb1()
    {
        return (150+$bossex)*(1+0.5*(1*log(M_E+($time/50)))*(1*log(M_E+($time/50)))*log(400/getbossperc()))*($bossamp);
    }
    
    function getdpsb2()
    {
        return (275+$bossex)*(1+0.5*(1.2*log(M_E+($time/100)))*(1.2*log(M_E+($time/100)))*log(400/getbossperc()))*($bossamp);
    }
    
    
    function damagetoboss()
    {
        $dmgdiff -= (getdpss()*0.1);
    }
    
    function damagetostd()
    {
        if($stun<=0)
            if($bossphase==1)
                $dmgdiff+=(getdpsb1()*0.1);
            else
                $dmgdiff+=(getdpsb2()*0.1);
    }
    
    
    function timer()
    {
        $time += $tincrement;
    }

    function stun_boss($seconds)
    {
        while(1==1){
            $stun = $seconds;

        }
        
        //$stundur = setInterval(function(){stun_countdown();},1000);
        //TODO while loop

    }

    function stun_countdown()
    {
        $stun-=1;
        if($stun==0)
        {
            clearInterval(stundur);
        }
    }
    
    function getbossperc()
    {
        return 100*($wingoal+$dmgdiff)/($wingoal*2);
    }
    
    /*
    setInterval(function(){console.log(dmgdiff)},100);
    setInterval(function(){console.log("Boss dps ="+getdpsb1())},100);
    setInterval(function(){console.log("Student dps ="+getdpss())},100);
    setInterval(function(){timer();},1000);
    setInterval(function(){damagetoboss()},100);
    setInterval(function(){damagetostd()},100);
    setInterval(function(){bosshp.update()},100);
    setInterval(function(){timer();},1000);
    */

    function manual_atk($dmg)
    {
        $dmgdiff -= $dmg;
        if ($item_13_check == 1)
        {
            $stdex += 0.5;
        }
        if ($item_14_check == 1)
        {
            $stdadd += 0.1;
        }
    }

    function item_main_1 ()
    {
        stun_boss(5);
    }
    
    function item_main_2()
    {
        $stdadd+=10;
    }

    function item_main_3 ()
    {
        $stdex += 20;
    }

    function item_main_4 ()
    {
        $dmg = getdpss() * 5;
        $dmgdiff = $dmgdiff - $dmg;
    }

    function item_extra_1 ()
    {
        $bossamp = $bossamp*0.95;
    }

    function item_extra_2 ()
    {
        $stdamp = $stdamp * 1.05;
    }

    function item_extra_3 ()
    {
        $time = $time/1.25;
        $tincrement = $tincrement/1.25;
    }

    function item_extra_4 ()
    {
        $stdadd+=50;
    }

    function item_extra_6 ()
    {
        $stdex += 100;
    }

    function item_extra_7 ()
    {
        if ($bossphase == 1)
        {
            $dmg = getdpsb1()*0.75;
        }
        else {
            $dmg = getdpsb2()*0.75;
        }
        $dmgdiff = $dmgdiff - $dmg;
    }

    function bstcountdown_std()
    {
        $booster_countdown -= 1;
        if($booster_countdown == 0)
        {
            clearInterval(a);
            $stud_tempmod /= 2;
        }
    }

    function item_extra_8 ()
    {
        if($booster_countdown!=0)

        {
            $booster_countdown+=60;
            return;
        }
        $stud_tempmod *= 2;
        $booster_countdown = 60;
        //$a = setInterval(function(){bstcountdown_std()},1000);
    }

    function bstcountdown_boss()
    {
        $booster_countdown -= 1;
        if($booster_countdown == 0)
        {
            //clearInterval(a);
            $boss_tempmod *= 2;
        }
    }

    function item_extra_9 ()
    {
        $boss_tempmod /= 2;
        $booster_countdown = 60;
        //$a = setInterval(function(){bstcountdown_boss()},1000);
    }

    function item_extra_10 ()
    {
        stun_boss(15);
    }

    function item_extra_11 ()
    {
        $time -= 100;
    }

    function item_extra_12 ()
    {
        $dmgdiff = (($dmgdiff+$wingoal)/2)-$wingoal;
        //console.log(dmgdiff);
    }

    function item_extra_13 ()
    {
        $item_13_check = 1;
    }

    function item_extra_14 ()
    {
        $item_14_check = 1;
    }






    $conn = connect_db();
    $sql = $conn->query("UPDATE hp SET hp_boss = ".$_POST['hp']."");
    if(!$sql){
        echo "fail";
    }
    else{
        echo "done";
    }
?>  